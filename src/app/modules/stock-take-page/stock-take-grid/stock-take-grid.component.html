<div class="container">
  <!-- Dynamic Cards for each location -->
  <div
    class="card"
    *ngFor="let location of getFilteredLocations(); let i = index"
  >
    <!-- Card Header -->
    <div class="card-header" (click)="toggleAccordion('location-' + i)">
      <input
        type="checkbox"
        [checked]="isAllFoundInLocation(location)"
        (click)="$event.stopPropagation()"
        (change)="onLocationCheckboxChange(location, $any($event.target).checked)"
        style="margin-right: 8px;"
      />
      <span
        class="chevron"
        [class.open]="accordionState['location-' + i]"
      ></span>
      <span>
        {{ location }} | Total: [SER
        {{ locationCounts[location].serviceable || 0 }}] [<span
          class="danger-text"
          >DAM {{ locationCounts[location].damaged || 0 }}</span
        >]
      </span>
      <span class="spacer"></span>
      <span class="open-count">(Open: {{ getOpenCountForLocation(location) }})</span>
    </div>

    <!-- Card Content (collapsible) -->
    <div class="card-content" *ngIf="accordionState['location-' + i]">
      <div
        class="section"
        *ngFor="let uldType of getSortedTypes(location); let j = index"
      >
        <div
          class="section-header"
          (click)="toggleAccordion('type-' + i + '-' + j)"
        >
          <input
            type="checkbox"
            [checked]="isAllFoundInType(location, uldType)"
            (click)="$event.stopPropagation()"
            (change)="onTypeCheckboxChange(location, uldType, $any($event.target).checked)"
            style="margin-right: 8px;"
          />
          <span
            class="chevron"
            [class.open]="accordionState['type-' + i + '-' + j]"
          ></span>
          <span>
            {{ uldType }} | Total:
            {{ groupedData[location][uldType].length }} [SER
            {{ getCounts(groupedData[location][uldType]).serviceable }}]
            [<span class="danger-text">
              DAM
              {{ getCounts(groupedData[location][uldType]).damaged }}
            </span>]
          </span>
          <span class="spacer"></span>
          <span class="open-count">(Open: {{ getOpenCountForType(location, uldType) }})</span>
        </div>

        <div
          class="section-content"
          *ngIf="accordionState['type-' + i + '-' + j]"
        >
          <div class="uld-item" *ngFor="let uld of groupedData[location][uldType]">
            <span class="uld-id">{{ uld.uldItemIdentifier }}</span>
            <input
              type="checkbox"
              [checked]="uld.isFound"
              (change)="toggleUldFoundStatus(uld.uldItemIdentifier)"
            />

            <span
              (click)="updateUldCondition(uld.uldItemIdentifier, 'Serviceable')"
              class="tag"
              [ngClass]="{
                'ser-tag': uld.conditionId === 'Serviceable',
                'disabled-tag': uld.conditionId !== 'Serviceable'
              }"
            >
              SER
            </span>

            <span
              (click)="updateUldCondition(uld.uldItemIdentifier, 'Damaged')"
              class="tag"
              [ngClass]="{
                'dam-tag': uld.conditionId === 'Damaged',
                'disabled-tag': uld.conditionId !== 'Damaged'
              }"
            >
              DAM
            </span>

            <!-- Removal button for additional ULDs -->
            <button
              *ngIf="uld.isAdditional"
              class="remove-btn"
              type="button"
              (click)="removeAdditionalUld(uld.uldItemIdentifier)"
              title="Remove"
            >
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
