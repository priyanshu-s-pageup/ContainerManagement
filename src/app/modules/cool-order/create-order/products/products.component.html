<div class="card">
  <div class="card-header">
    <h3>Products</h3>
    <button type="button" class="add-btn" title="Add Product" (click)="addEntry()" [disabled]="entries.length >= 5">
      <span class="btn-icon">+</span>
    </button>
  </div>

  <form>
    <ng-container *ngFor="let entry of entries; let i = index">
      <div class="form-row" style="align-items:center; justify-content:space-between; margin-top:8px;">
        <div>
          <strong>Product {{ i + 1 }}</strong>
        </div>
        <div *ngIf="i > 0">
          <button type="button" class="add-btn" title="Remove" (click)="removeEntry(i)">âˆ’</button>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <select class="form-select" [(ngModel)]="entry.selectedGroup" name="group-{{i}}" (change)="onGroupChange(i)" required aria-required="true">
            <option value="">Group</option>
            <option *ngFor="let g of groups" [value]="g">{{ g }}</option>
          </select>
          <small *ngIf="entry.selectedGroup && !supplier" style="color:#d32f2f">please select the supplier</small>
          <!-- <small *ngIf="!entry.selectedGroup" style="color:#d32f2f">Required.</small> -->
        </div>
        <div class="form-group">
          <input
            type="text"
            class="form-input"
            placeholder="Product code"
            [(ngModel)]="entry.productCode"
            name="productCode-{{i}}" required aria-required="true"
          />
          <small *ngIf="entry.productCode && !isProductCodeValid(i)" style="color:#d32f2f">Invalid code. Use first 3 letters + 4 digits.</small>
          <small *ngIf="entry.productCode && !supplier" style="color:#d32f2f">please select the supplier</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <select class="form-select" [(ngModel)]="entry.selectedProduct" name="product-{{i}}" (change)="onProductChange()" required aria-required="true">
            <option value="">Product</option>
            <ng-container *ngIf="availableProducts(i).length; else noProducts">
              <option *ngFor="let p of availableProducts(i)" [value]="p">{{ p }}</option>
            </ng-container>
          </select>
          <!-- <small *ngIf="!entry.selectedProduct" style="color:#d32f2f">Required.</small> -->
          <small *ngIf="entry.selectedProduct && !supplier" style="color:#d32f2f">please select the supplier</small>
          <ng-template #noProducts>
            <option value="">Select a group first</option>
          </ng-template>
        </div>
        <div class="form-group">
          <input
            type="number"
            class="form-input"
            placeholder="Quantity"
            [(ngModel)]="entry.quantity"
            name="quantity-{{i}}"
            min="1"
            max="9"
            (change)="onQuantityChange()" required aria-required="true"
          />
          <!-- <small *ngIf="!entry.quantity" style="color:#d32f2f">Required.</small> -->
          <small *ngIf="entry.quantity !== null && !isQuantityValid(i)" style="color:#d32f2f">Quantity must be 1-9.</small>
          <small *ngIf="entry.quantity && !supplier" style="color:#d32f2f">please select the supplier</small>
        </div>
      </div>
    </ng-container>
  </form>

</div>
